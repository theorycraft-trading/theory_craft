# TheoryCraft

```elixir
Mix.install(
  [
    {:tzdata, "~> 1.1"},
    {:theory_craft, path: "D:/Documents/Dev/Elixir/theorycraft", override: true},
    {:theory_craft_ta, path: "D:/Documents/Dev/Elixir/theory_craft_ta", override: true},
    {:kino_theory_craft,
     path: "D:/Documents/Dev/Elixir/theorycraft/.deps/kino_theory_craft"}
  ],
  consolidate_protocols: false
)

Application.put_env(:elixir, :time_zone_database, Tzdata.TimeZoneDatabase)

Logger.configure(level: :info)
```

## AAA

```elixir
alias TheoryCraft.MarketSource.TicksCSVDataFeed

filename = "D:/Documents/Dev/trading/python/data/XAUUSD_Ticks_18.08.2025-18.08.2025.csv"

opts = [
  file: filename,
  name: "XAUUSD",
  time: "Local time",
  ask: "Ask",
  bid: "Bid",
  ask_volume: "AskVolume",
  bid_volume: "BidVolume",
  skip_headers: false,
  time_format: :dukascopy
]

csv_stream =  TicksCSVDataFeed.stream!(opts)
```

```elixir
require TheoryCraftTA.TA, as: TA

alias TheoryCraft.MarketSource.MarketEvent
alias TheoryCraft.MarketSource
alias KinoTheoryCraft.Chart

market_source =
  %MarketSource{}
  |> MarketSource.add_data(csv_stream, name: "data")
  |> MarketSource.resample("m5", bar_only: true, name: "data_m5")
  |> MarketSource.add_indicators_layer([
    TA.sma(data_m5[:close], 8, name: "sma_8"),
    TA.ema(data_m5[:close], 13, name: "ema_13")
  ])

chart =
  Chart.new(width: :auto, height: 400, debug: true)
  |> Chart.set_source(market_source)
  |> Chart.add_data_from_source("data_m5", :candlestick,
    options: %{
      up_color: "#00bfff",
      down_color: "#683ab6",
      border_visible: true,
      border_up_color: "#0288d1",
      border_down_color: "#4527a0",
      wick_up_color: "#0288d1",
      wick_down_color: "#4527a0"
    }
  )
  |> Chart.add_data_from_source("sma_8", :line, options: %{color: "orange"})
  |> Chart.add_data_from_source(
    "ema_13",
    :area,
    pane: 1,
    options: %{
      line_color: "pink",
      top_color: "#00c853",
      bottom_color: "#683ab6",
      point_markers_visible: true
    }
  )
```

```elixir
alias KinoTheoryCraft.{Chart, LiveChart}

candlestick_options = %{
  up_color: "#00bfff",
  down_color: "#683ab6",
  border_visible: true,
  border_up_color: "#00c853",
  border_down_color: "#683ab6",
  wick_up_color: "#00c853",
  wick_down_color: "#683ab6"
}

area_options = %{
  top_color: "#00c853",
  bottom_color: "#683ab6"
}

market_source =
  %MarketSource{}
  |> MarketSource.add_data(csv_stream, name: "data")
  |> MarketSource.resample("m5", name: "data_m5")
  |> MarketSource.add_indicators_layer([
    TA.sma(data_m5[:close], 8, name: "sma_8"),
    TA.ema(data_m5[:close], 13, name: "ema_13")
  ])

# Create LiveChart
chart =
  Chart.new(width: :auto, height: 400)
  |> Chart.add_series("data_m5", :candlestick, options: candlestick_options)
  |> Chart.add_series("sma_8", :line, options: %{color: "teal"})
  |> Chart.add_series("ema_13", :area, pane: 1, options: area_options)
  |> LiveChart.render(debug: true, batch_size: 1000)

# Render
Kino.render(chart)

# Update
for event <- MarketSource.stream(market_source) do
  # Process.sleep(100)
  LiveChart.update(chart, event)
end
```

## TheoryCraft

```elixir
defmodule TheoryCraft.Test do
  @moduledoc """
  Documentation for `TheoryCraft`.
  """

  import TheoryCraft.MarketSimulator

  alias TheoryCraft.MarketSimulator
  alias TheoryCraft.Utils

  ## Public API

  def test() do
    dir = "D:/Documents/Dev/trading/python/data"
    
    filename = "XAUUSD_Ticks_18.08.2025-18.08.2025.csv"
    full_path = Path.join(dir, filename)
    opts = dukascopy_opts()
    
    # filename = "ticks_XAUUSD_Minute_20240101_230202_20241231_215859.csv"
    # full_path = Path.join(dir, filename)
    # opts = ctrader_opts()

    stream =
      %MarketSimulator{}
      # |> add_data(memory_stream, name: "ticks")
      |> add_data_ticks_from_csv(full_path, opts)
      |> resample("D", data: "XAUUSD", name: "XAUUSD_daily")
      |> stream()
      |> Enum.take(3)
      |> IO.inspect()

    count = time("Stream", fn -> Enum.count(stream) end)
    IO.puts("Count: #{count}")
  end

  ## Private functions

  defp dukascopy_opts() do
    [
      name: "XAUUSD",
      time: "Local time",
      ask: "Ask",
      bid: "Bid",
      ask_volume: "AskVolume",
      bid_volume: "BidVolume",
      skip_headers: false,
      time_format: :dukascopy
    ]
  end

  defp ctrader_opts() do
    [
      name: "XAUUSD",
      time: "Timestamp",
      ask: "Ask",
      bid: "Bid",
      ask_volume: "AskVolume",
      bid_volume: "BidVolume",
      skip_headers: false
    ]
  end

  defp time(name, fun) do
    {time, value} = :timer.tc(fun, :millisecond)
    IO.puts("#{name} took #{Utils.duration_ms_to_string(time)}")
    value
    end
end


TheoryCraft.Test.test()
```

```elixir
# dir = "D:/Documents/Dev/trading/python/data"
# filename = "XAUUSD_Ticks_18.08.2025-18.08.2025.csv"
# full = Path.join(dir, filename)

# content =
#   full
#   |> File.stream!()
#   |> Enum.take(51)
#   |> Enum.join()

# File.write!(
#   "D:/Documents/Dev/Elixir/theorycraft/test/fixtures/XAUUSD_ticks_dukascopy.csv",
# content
# )


# %MarketSource{}
# # |> add_data_from_csv("tick_xauusd.csv", name: "xauusd_ticks")
# |> add_data("tick_xauusd.csv")
# |> resample("m5")
# |> resample("D", data: 0, name: "xauusd_daily")
# |> add_indicator(TheoryCraft.Indicators.SMA, period: 14, data: "xauusd_daily", name: "sma_14")
# |> add_indicator(TheoryCraft.Indicators.Supertrend, period: 14, name: "supertrend_14", data: 0)
```

<!-- livebook:{"attrs":"e30","chunks":[],"kind":"Elixir.KinoTheoryCraft.TheoryCraftCell","livebook_object":"smart_cell"} -->

```elixir

```

## KinoTheoryCraft

```elixir
alias TheoryCraft.MarketSource.TicksCSVDataFeed

filename = "D:/Documents/Dev/trading/python/data/XAUUSD_Ticks_18.08.2025-18.08.2025.csv"

opts = [
  file: filename,
  name: "XAUUSD",
  time: "Local time",
  ask: "Ask",
  bid: "Bid",
  ask_volume: "AskVolume",
  bid_volume: "BidVolume",
  skip_headers: false,
  time_format: :dukascopy
]

input_file = 
  opts
  |> TicksCSVDataFeed.stream!()
  |> KinoTheoryCraft.Input.stream(name: Path.basename(filename))
```

<!-- livebook:{"attrs":"eyJpbnB1dF92YXJpYWJsZSI6IiIsInRhc2tfaWQiOiJyZXNhbXBsZSIsInRpbWVmcmFtZV9tdWx0aXBsaWVyIjo1LCJ0aW1lZnJhbWVfdW5pdCI6Im0iLCJ0aW1lem9uZSI6IkV1cm9wZS9QYXJpcyJ9","chunks":[],"kind":"Elixir.KinoTheoryCraft.TheoryCraftCell","livebook_object":"smart_cell"} -->

```elixir

```

```elixir
require TheoryCraftTA.TA, as: TA

alias TheoryCraft.MarketSource.MarketEvent
alias TheoryCraft.MarketSource
alias KinoTheoryCraft.Chart

Logger.configure(level: :info)

market_source =
  %MarketSource{}
  |> MarketSource.add_data(input_file.stream, name: "data")
  |> MarketSource.resample("m5", name: "data_m5")
  |> MarketSource.add_indicators_layer([
    TA.sma(data_m5[:close], 8, name: "sma_8"),
    TA.ema(data_m5[:close], 13, name: "ema_13"),
  ])
  |> MarketSource.stream()

chart =
  Chart.new(width: :auto, height: 400, debug: true)
  |> Chart.set_source(market_source)
  |> Chart.add_data_from_source("data_m5", :candlestick)
  |> Chart.add_data_from_source("sma_8", :line)
  |> Chart.add_data_from_source("ema_13", :area, pane: 1)
```
